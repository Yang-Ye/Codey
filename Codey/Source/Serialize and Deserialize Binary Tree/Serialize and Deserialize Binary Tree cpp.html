<!-- HTML generated by Yang Ye --><div style="background: #ffffff; overflow:auto;width:auto;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span></span><span style="color: #888888">// Time:  O(n)</span>
<span style="color: #888888">// Space: O(h)</span>

<span style="color: #888888">/**</span>
<span style="color: #888888"> * Definition for a binary tree node.</span>
<span style="color: #888888"> * struct TreeNode {</span>
<span style="color: #888888"> *     int val;</span>
<span style="color: #888888"> *     TreeNode *left;</span>
<span style="color: #888888"> *     TreeNode *right;</span>
<span style="color: #888888"> *     TreeNode(int x) : val(x), left(NULL), right(NULL) {}</span>
<span style="color: #888888"> * };</span>
<span style="color: #888888"> */</span>
<span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">Codec</span> {
<span style="color: #008800; font-weight: bold">public</span><span style="color: #333333">:</span>

    <span style="color: #888888">// Encodes a tree to a single string.</span>
    string serialize(TreeNode<span style="color: #333333">*</span> root) {
        string output;
        serializeHelper(root, <span style="color: #333333">&amp;</span>output);
        <span style="color: #008800; font-weight: bold">return</span> output;
    }

    <span style="color: #888888">// Decodes your encoded data to tree.</span>
    TreeNode<span style="color: #333333">*</span> deserialize(string data) {
        TreeNode <span style="color: #333333">*</span>root <span style="color: #333333">=</span> <span style="color: #008800; font-weight: bold">nullptr</span>;
        <span style="color: #333399; font-weight: bold">int</span> start <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>;
        <span style="color: #008800; font-weight: bold">return</span> <span style="color: #0066BB; font-weight: bold">deserializeHelper</span>(data, <span style="color: #333333">&amp;</span>start);
    }

<span style="color: #008800; font-weight: bold">private</span><span style="color: #333333">:</span>
    <span style="color: #333399; font-weight: bold">bool</span> getNumber(<span style="color: #008800; font-weight: bold">const</span> string <span style="color: #333333">&amp;</span>data, <span style="color: #333399; font-weight: bold">int</span> <span style="color: #333333">*</span>start, <span style="color: #333399; font-weight: bold">int</span> <span style="color: #333333">*</span>num) {
        <span style="color: #333399; font-weight: bold">int</span> sign <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">1</span>;
        <span style="color: #008800; font-weight: bold">if</span> (data[<span style="color: #333333">*</span>start] <span style="color: #333333">==</span> <span style="color: #0044DD">&#39;#&#39;</span>) {
            <span style="color: #333333">*</span>start <span style="color: #333333">+=</span> <span style="color: #0000DD; font-weight: bold">2</span>;  <span style="color: #888888">// Skip &quot;# &quot;.</span>
            <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">false</span>;
        } <span style="color: #008800; font-weight: bold">else</span> <span style="color: #008800; font-weight: bold">if</span> (data[<span style="color: #333333">*</span>start] <span style="color: #333333">==</span> <span style="color: #0044DD">&#39;-&#39;</span>) {
            sign <span style="color: #333333">=</span> <span style="color: #333333">-</span><span style="color: #0000DD; font-weight: bold">1</span>;
            <span style="color: #333333">++</span>(<span style="color: #333333">*</span>start);
        }

        <span style="color: #008800; font-weight: bold">for</span> (<span style="color: #333333">*</span>num <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>; isdigit(data[<span style="color: #333333">*</span>start]); <span style="color: #333333">++</span>(<span style="color: #333333">*</span>start)) {
            <span style="color: #333333">*</span>num <span style="color: #333333">=</span> <span style="color: #333333">*</span>num <span style="color: #333333">*</span> <span style="color: #0000DD; font-weight: bold">10</span> <span style="color: #333333">+</span> data[<span style="color: #333333">*</span>start] <span style="color: #333333">-</span> <span style="color: #0044DD">&#39;0&#39;</span>;
        }
        <span style="color: #333333">*</span>num <span style="color: #333333">*=</span> sign;
        <span style="color: #333333">++</span>(<span style="color: #333333">*</span>start);  <span style="color: #888888">// Skip &quot; &quot;.</span>

        <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">true</span>;
    }
    
    <span style="color: #333399; font-weight: bold">void</span> serializeHelper(<span style="color: #008800; font-weight: bold">const</span> TreeNode <span style="color: #333333">*</span>root, string <span style="color: #333333">*</span>prev) {
        <span style="color: #008800; font-weight: bold">if</span> (<span style="color: #333333">!</span>root)  {
            prev<span style="color: #333333">-&gt;</span>append(<span style="background-color: #fff0f0">&quot;# &quot;</span>);
        } <span style="color: #008800; font-weight: bold">else</span> {
            prev<span style="color: #333333">-&gt;</span>append(to_string(root<span style="color: #333333">-&gt;</span>val).append(<span style="background-color: #fff0f0">&quot; &quot;</span>));
            serializeHelper(root<span style="color: #333333">-&gt;</span>left, prev);
            serializeHelper(root<span style="color: #333333">-&gt;</span>right, prev);
        }
    }

    TreeNode <span style="color: #333333">*</span>deserializeHelper(<span style="color: #008800; font-weight: bold">const</span> string<span style="color: #333333">&amp;</span> data, <span style="color: #333399; font-weight: bold">int</span> <span style="color: #333333">*</span>start) {
        <span style="color: #333399; font-weight: bold">int</span> num;
        <span style="color: #008800; font-weight: bold">if</span> (<span style="color: #333333">!</span>getNumber(data, start, <span style="color: #333333">&amp;</span>num)) {
            <span style="color: #008800; font-weight: bold">return</span> <span style="color: #008800; font-weight: bold">nullptr</span>;
        } <span style="color: #008800; font-weight: bold">else</span> {
            TreeNode <span style="color: #333333">*</span>root <span style="color: #333333">=</span> <span style="color: #008800; font-weight: bold">new</span> TreeNode(num);
            root<span style="color: #333333">-&gt;</span>left <span style="color: #333333">=</span> deserializeHelper(data, start);
            root<span style="color: #333333">-&gt;</span>right <span style="color: #333333">=</span> deserializeHelper(data, start);
            <span style="color: #008800; font-weight: bold">return</span> root;
        }
    }
};


<span style="color: #888888">// Time:  O(n)</span>
<span style="color: #888888">// Space: O(n)</span>
<span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">Codec2</span> {
<span style="color: #008800; font-weight: bold">public</span><span style="color: #333333">:</span>

    <span style="color: #888888">// Encodes a tree to a single string.</span>
    string serialize(TreeNode<span style="color: #333333">*</span> root) {
        ostringstream out;
        serializeHelper(root, out);
        <span style="color: #008800; font-weight: bold">return</span> out.str();
    }

    <span style="color: #888888">// Decodes your encoded data to tree.</span>
    TreeNode<span style="color: #333333">*</span> deserialize(string data) {
        istringstream in(data);  <span style="color: #888888">// Space: O(n)</span>
        <span style="color: #008800; font-weight: bold">return</span> <span style="color: #0066BB; font-weight: bold">deserializeHelper</span>(in);
    }

<span style="color: #008800; font-weight: bold">private</span><span style="color: #333333">:</span>
    <span style="color: #333399; font-weight: bold">void</span> serializeHelper(<span style="color: #008800; font-weight: bold">const</span> TreeNode <span style="color: #333333">*</span>root, ostringstream<span style="color: #333333">&amp;</span> out) {
        <span style="color: #008800; font-weight: bold">if</span> (<span style="color: #333333">!</span>root)  {
            out <span style="color: #333333">&lt;&lt;</span> <span style="background-color: #fff0f0">&quot;# &quot;</span>;
        } <span style="color: #008800; font-weight: bold">else</span> {
            out <span style="color: #333333">&lt;&lt;</span> root<span style="color: #333333">-&gt;</span>val <span style="color: #333333">&lt;&lt;</span> <span style="background-color: #fff0f0">&quot; &quot;</span>;
            serializeHelper(root<span style="color: #333333">-&gt;</span>left, out);
            serializeHelper(root<span style="color: #333333">-&gt;</span>right, out);
        }
    }

    TreeNode <span style="color: #333333">*</span>deserializeHelper(istringstream<span style="color: #333333">&amp;</span> in) {
        string val;
        in <span style="color: #333333">&gt;&gt;</span> val;
        <span style="color: #008800; font-weight: bold">if</span> (val <span style="color: #333333">==</span> <span style="background-color: #fff0f0">&quot;#&quot;</span>) {
            <span style="color: #008800; font-weight: bold">return</span> <span style="color: #008800; font-weight: bold">nullptr</span>;
        } <span style="color: #008800; font-weight: bold">else</span> {
            TreeNode<span style="color: #333333">*</span> root <span style="color: #333333">=</span> <span style="color: #008800; font-weight: bold">new</span> TreeNode(stoi(val));
            root<span style="color: #333333">-&gt;</span>left <span style="color: #333333">=</span> deserializeHelper(in);
            root<span style="color: #333333">-&gt;</span>right <span style="color: #333333">=</span> deserializeHelper(in);
            <span style="color: #008800; font-weight: bold">return</span> root;
        }
    }
};

<span style="color: #888888">// Your Codec object will be instantiated and called as such:</span>
<span style="color: #888888">// Codec codec;</span>
<span style="color: #888888">// codec.deserialize(codec.serialize(root));</span>
</pre></div>
