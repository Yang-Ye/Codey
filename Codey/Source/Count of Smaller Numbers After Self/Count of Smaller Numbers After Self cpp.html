<!-- HTML generated by Yang Ye --><div style="background: #ffffff; overflow:auto;width:auto;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span></span><span style="color: #888888">// Time:  O(nlogn)</span>
<span style="color: #888888">// Space: O(n)</span>

<span style="color: #888888">// BST solution. (40ms)</span>
<span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">Solution</span> {
<span style="color: #008800; font-weight: bold">public</span><span style="color: #333333">:</span>
    <span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">BSTreeNode</span> {
    <span style="color: #008800; font-weight: bold">public</span><span style="color: #333333">:</span>
        <span style="color: #333399; font-weight: bold">int</span> val, count;
        BSTreeNode <span style="color: #333333">*</span>left, <span style="color: #333333">*</span>right;
        BSTreeNode(<span style="color: #333399; font-weight: bold">int</span> val, <span style="color: #333399; font-weight: bold">int</span> count) {
            <span style="color: #008800; font-weight: bold">this</span><span style="color: #333333">-&gt;</span>val <span style="color: #333333">=</span> val;
            <span style="color: #008800; font-weight: bold">this</span><span style="color: #333333">-&gt;</span>count <span style="color: #333333">=</span> count;
            <span style="color: #008800; font-weight: bold">this</span><span style="color: #333333">-&gt;</span>left <span style="color: #333333">=</span> <span style="color: #008800; font-weight: bold">this</span><span style="color: #333333">-&gt;</span>right <span style="color: #333333">=</span> <span style="color: #008800; font-weight: bold">nullptr</span>;
        }
    };

    vector<span style="color: #333333">&lt;</span><span style="color: #333399; font-weight: bold">int</span><span style="color: #333333">&gt;</span> countSmaller(vector<span style="color: #333333">&lt;</span><span style="color: #333399; font-weight: bold">int</span><span style="color: #333333">&gt;&amp;</span> nums) {
        vector<span style="color: #333333">&lt;</span><span style="color: #333399; font-weight: bold">int</span><span style="color: #333333">&gt;</span> res(nums.size());

        BSTreeNode <span style="color: #333333">*</span>root <span style="color: #333333">=</span> <span style="color: #008800; font-weight: bold">nullptr</span>;

        <span style="color: #888888">// Insert into BST and get left count.</span>
        <span style="color: #008800; font-weight: bold">for</span> (<span style="color: #333399; font-weight: bold">int</span> i <span style="color: #333333">=</span> nums.size() <span style="color: #333333">-</span> <span style="color: #0000DD; font-weight: bold">1</span>; i <span style="color: #333333">&gt;=</span> <span style="color: #0000DD; font-weight: bold">0</span>; <span style="color: #333333">--</span>i) {
            BSTreeNode <span style="color: #333333">*</span>node <span style="color: #333333">=</span> <span style="color: #008800; font-weight: bold">new</span> BSTreeNode(nums[i], <span style="color: #0000DD; font-weight: bold">0</span>);
            root <span style="color: #333333">=</span> insertNode(root, node);
            res[i] <span style="color: #333333">=</span> query(root, nums[i]);
        }

        <span style="color: #008800; font-weight: bold">return</span> res;
    }

    <span style="color: #888888">// Insert node into BST.</span>
    BSTreeNode<span style="color: #333333">*</span> insertNode(BSTreeNode<span style="color: #333333">*</span> root, BSTreeNode<span style="color: #333333">*</span> node) {
        <span style="color: #008800; font-weight: bold">if</span> (root <span style="color: #333333">==</span> <span style="color: #008800; font-weight: bold">nullptr</span>) {
            <span style="color: #008800; font-weight: bold">return</span> node;
        }
        BSTreeNode<span style="color: #333333">*</span> curr <span style="color: #333333">=</span> root;
        <span style="color: #008800; font-weight: bold">while</span> (curr) {
            <span style="color: #888888">// Insert left if smaller.</span>
            <span style="color: #008800; font-weight: bold">if</span> (node<span style="color: #333333">-&gt;</span>val <span style="color: #333333">&lt;</span> curr<span style="color: #333333">-&gt;</span>val) {
                <span style="color: #333333">++</span>curr<span style="color: #333333">-&gt;</span>count; <span style="color: #888888">// Increase the number of left children.</span>
                <span style="color: #008800; font-weight: bold">if</span> (curr<span style="color: #333333">-&gt;</span>left <span style="color: #333333">!=</span> <span style="color: #008800; font-weight: bold">nullptr</span>) {
                    curr <span style="color: #333333">=</span> curr<span style="color: #333333">-&gt;</span>left;
                } <span style="color: #008800; font-weight: bold">else</span> {
                    curr<span style="color: #333333">-&gt;</span>left <span style="color: #333333">=</span> node;
                    <span style="color: #008800; font-weight: bold">break</span>;
                }
            } <span style="color: #008800; font-weight: bold">else</span> {  <span style="color: #888888">// Insert right if larger or equal.</span>
                <span style="color: #008800; font-weight: bold">if</span> (curr<span style="color: #333333">-&gt;</span>right <span style="color: #333333">!=</span> <span style="color: #008800; font-weight: bold">nullptr</span>) {
                    curr <span style="color: #333333">=</span> curr<span style="color: #333333">-&gt;</span>right;
                } <span style="color: #008800; font-weight: bold">else</span> {
                    curr<span style="color: #333333">-&gt;</span>right <span style="color: #333333">=</span> node;
                    <span style="color: #008800; font-weight: bold">break</span>;
                }
            }
        }
        <span style="color: #008800; font-weight: bold">return</span> root;
    }

    <span style="color: #888888">// Query the smaller count of the value.</span>
    <span style="color: #333399; font-weight: bold">int</span> query(BSTreeNode<span style="color: #333333">*</span> root, <span style="color: #333399; font-weight: bold">int</span> val) {
        <span style="color: #008800; font-weight: bold">if</span> (root <span style="color: #333333">==</span> <span style="color: #008800; font-weight: bold">nullptr</span>) {
            <span style="color: #008800; font-weight: bold">return</span> <span style="color: #0000DD; font-weight: bold">0</span>;
        }
        <span style="color: #333399; font-weight: bold">int</span> count <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>;
        BSTreeNode<span style="color: #333333">*</span> curr <span style="color: #333333">=</span> root;
        <span style="color: #008800; font-weight: bold">while</span> (curr) {
            <span style="color: #888888">// Insert left.</span>
            <span style="color: #008800; font-weight: bold">if</span> (val <span style="color: #333333">&lt;</span> curr<span style="color: #333333">-&gt;</span>val) {
                curr <span style="color: #333333">=</span> curr<span style="color: #333333">-&gt;</span>left;
            } <span style="color: #008800; font-weight: bold">else</span> <span style="color: #008800; font-weight: bold">if</span> (val <span style="color: #333333">&gt;</span> curr<span style="color: #333333">-&gt;</span>val) {
                count <span style="color: #333333">+=</span> <span style="color: #0000DD; font-weight: bold">1</span> <span style="color: #333333">+</span> curr<span style="color: #333333">-&gt;</span>count; <span style="color: #888888">// Count the number of the smaller nodes.</span>
                curr <span style="color: #333333">=</span> curr<span style="color: #333333">-&gt;</span>right;
            } <span style="color: #008800; font-weight: bold">else</span> {  <span style="color: #888888">// Equal.</span>
                <span style="color: #008800; font-weight: bold">return</span> count <span style="color: #333333">+</span> curr<span style="color: #333333">-&gt;</span>count;
            }
        }
        <span style="color: #008800; font-weight: bold">return</span> <span style="color: #0000DD; font-weight: bold">0</span>;
    }
};

<span style="color: #888888">// Time:  O(nlogn)</span>
<span style="color: #888888">// Space: O(n)</span>
<span style="color: #888888">// BIT solution. (56ms)</span>
<span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">Solution2</span> {
<span style="color: #008800; font-weight: bold">public</span><span style="color: #333333">:</span>
    vector<span style="color: #333333">&lt;</span><span style="color: #333399; font-weight: bold">int</span><span style="color: #333333">&gt;</span> countSmaller(vector<span style="color: #333333">&lt;</span><span style="color: #333399; font-weight: bold">int</span><span style="color: #333333">&gt;&amp;</span> nums) {
        <span style="color: #888888">// Get the place (position in the ascending order) of each number.</span>
        vector<span style="color: #333333">&lt;</span><span style="color: #333399; font-weight: bold">int</span><span style="color: #333333">&gt;</span> sorted_nums(nums), places(nums.size());
        sort(sorted_nums.begin(), sorted_nums.end());
        <span style="color: #008800; font-weight: bold">for</span> (<span style="color: #333399; font-weight: bold">int</span> i <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> nums.size(); <span style="color: #333333">++</span>i) {
            places[i] <span style="color: #333333">=</span> 
                lower_bound(sorted_nums.begin(), sorted_nums.end(), nums[i]) <span style="color: #333333">-</span>
                sorted_nums.begin();
        }
        <span style="color: #888888">// Count the smaller elements after the number.</span>
        vector<span style="color: #333333">&lt;</span><span style="color: #333399; font-weight: bold">int</span><span style="color: #333333">&gt;</span> bit(nums.size() <span style="color: #333333">+</span> <span style="color: #0000DD; font-weight: bold">1</span>), ans(nums.size());
        <span style="color: #008800; font-weight: bold">for</span> (<span style="color: #333399; font-weight: bold">int</span> i <span style="color: #333333">=</span> nums.size() <span style="color: #333333">-</span> <span style="color: #0000DD; font-weight: bold">1</span>; i <span style="color: #333333">&gt;=</span> <span style="color: #0000DD; font-weight: bold">0</span>; <span style="color: #333333">--</span>i) {
            ans[i] <span style="color: #333333">=</span> query(bit, places[i]);
            add(bit, places[i] <span style="color: #333333">+</span> <span style="color: #0000DD; font-weight: bold">1</span>, <span style="color: #0000DD; font-weight: bold">1</span>);
        }
        <span style="color: #008800; font-weight: bold">return</span> ans;
    }

<span style="color: #008800; font-weight: bold">private</span><span style="color: #333333">:</span>
    <span style="color: #333399; font-weight: bold">void</span> add(vector<span style="color: #333333">&lt;</span><span style="color: #333399; font-weight: bold">int</span><span style="color: #333333">&gt;&amp;</span> bit, <span style="color: #333399; font-weight: bold">int</span> i, <span style="color: #333399; font-weight: bold">int</span> val) {
        <span style="color: #008800; font-weight: bold">for</span> (; i <span style="color: #333333">&lt;</span> bit.size(); i <span style="color: #333333">+=</span> lower_bit(i)) {
            bit[i] <span style="color: #333333">+=</span> val;
        }
    }

    <span style="color: #333399; font-weight: bold">int</span> query(<span style="color: #008800; font-weight: bold">const</span> vector<span style="color: #333333">&lt;</span><span style="color: #333399; font-weight: bold">int</span><span style="color: #333333">&gt;&amp;</span> bit, <span style="color: #333399; font-weight: bold">int</span> i) {
        <span style="color: #333399; font-weight: bold">int</span> sum <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>;
        <span style="color: #008800; font-weight: bold">for</span> (; i <span style="color: #333333">&gt;</span> <span style="color: #0000DD; font-weight: bold">0</span>; i <span style="color: #333333">-=</span> lower_bit(i)) {
            sum <span style="color: #333333">+=</span> bit[i];
        }
        <span style="color: #008800; font-weight: bold">return</span> sum;
    }

    <span style="color: #333399; font-weight: bold">int</span> lower_bit(<span style="color: #333399; font-weight: bold">int</span> i) {
        <span style="color: #008800; font-weight: bold">return</span> i <span style="color: #333333">&amp;</span> <span style="color: #333333">-</span>i;
    }
};

<span style="color: #888888">// Time:  O(nlogn)</span>
<span style="color: #888888">// Space: O(n)</span>
<span style="color: #888888">// Divide and Conquer solution. (80ms)</span>
<span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">Solution3</span> {
<span style="color: #008800; font-weight: bold">public</span><span style="color: #333333">:</span>
    vector<span style="color: #333333">&lt;</span><span style="color: #333399; font-weight: bold">int</span><span style="color: #333333">&gt;</span> countSmaller(vector<span style="color: #333333">&lt;</span><span style="color: #333399; font-weight: bold">int</span><span style="color: #333333">&gt;&amp;</span> nums) {
        vector<span style="color: #333333">&lt;</span><span style="color: #333399; font-weight: bold">int</span><span style="color: #333333">&gt;</span> counts(nums.size());
        vector<span style="color: #333333">&lt;</span>pair<span style="color: #333333">&lt;</span><span style="color: #333399; font-weight: bold">int</span>, <span style="color: #333399; font-weight: bold">int</span><span style="color: #333333">&gt;&gt;</span> num_idxs;
        <span style="color: #008800; font-weight: bold">for</span> (<span style="color: #333399; font-weight: bold">int</span> i <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> nums.size(); <span style="color: #333333">++</span>i) {
            num_idxs.emplace_back(nums[i], i);
        }
        countAndMergeSort(<span style="color: #333333">&amp;</span>num_idxs, <span style="color: #0000DD; font-weight: bold">0</span>, num_idxs.size() <span style="color: #333333">-</span> <span style="color: #0000DD; font-weight: bold">1</span>, <span style="color: #333333">&amp;</span>counts);
        <span style="color: #008800; font-weight: bold">return</span> counts;
    }

    <span style="color: #333399; font-weight: bold">void</span> countAndMergeSort(vector<span style="color: #333333">&lt;</span>pair<span style="color: #333333">&lt;</span><span style="color: #333399; font-weight: bold">int</span>, <span style="color: #333399; font-weight: bold">int</span><span style="color: #333333">&gt;&gt;</span> <span style="color: #333333">*</span>num_idxs, <span style="color: #333399; font-weight: bold">int</span> start, <span style="color: #333399; font-weight: bold">int</span> end, vector<span style="color: #333333">&lt;</span><span style="color: #333399; font-weight: bold">int</span><span style="color: #333333">&gt;</span> <span style="color: #333333">*</span>counts) {
        <span style="color: #008800; font-weight: bold">if</span> (end <span style="color: #333333">-</span> start <span style="color: #333333">&lt;=</span> <span style="color: #0000DD; font-weight: bold">0</span>) {  <span style="color: #888888">// The number of range [start, end] of which size is less than 2 doesn&#39;t need sort.</span>
            <span style="color: #008800; font-weight: bold">return</span>;
        }
        <span style="color: #333399; font-weight: bold">int</span> mid <span style="color: #333333">=</span> start <span style="color: #333333">+</span> (end <span style="color: #333333">-</span> start) <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">2</span>;
        countAndMergeSort(num_idxs, start, mid, counts);
        countAndMergeSort(num_idxs, mid <span style="color: #333333">+</span> <span style="color: #0000DD; font-weight: bold">1</span>, end, counts);

        <span style="color: #333399; font-weight: bold">int</span> r <span style="color: #333333">=</span> mid <span style="color: #333333">+</span> <span style="color: #0000DD; font-weight: bold">1</span>;
        vector<span style="color: #333333">&lt;</span>pair<span style="color: #333333">&lt;</span><span style="color: #333399; font-weight: bold">int</span>, <span style="color: #333399; font-weight: bold">int</span><span style="color: #333333">&gt;&gt;</span> tmp;
        <span style="color: #008800; font-weight: bold">for</span> (<span style="color: #333399; font-weight: bold">int</span> i <span style="color: #333333">=</span> start; i <span style="color: #333333">&lt;=</span> mid; <span style="color: #333333">++</span>i) {
            <span style="color: #888888">// Merge the two sorted arrays into tmp.</span>
            <span style="color: #008800; font-weight: bold">while</span> (r <span style="color: #333333">&lt;=</span> end <span style="color: #333333">&amp;&amp;</span> (<span style="color: #333333">*</span>num_idxs)[r].first <span style="color: #333333">&lt;</span> (<span style="color: #333333">*</span>num_idxs)[i].first) {
                tmp.emplace_back((<span style="color: #333333">*</span>num_idxs)[r<span style="color: #333333">++</span>]);
            }
            tmp.emplace_back((<span style="color: #333333">*</span>num_idxs)[i]);
            (<span style="color: #333333">*</span>counts)[(<span style="color: #333333">*</span>num_idxs)[i].second] <span style="color: #333333">+=</span> r <span style="color: #333333">-</span> (mid <span style="color: #333333">+</span> <span style="color: #0000DD; font-weight: bold">1</span>);
        }
        <span style="color: #888888">// Copy tmp back to num_idxs.</span>
        copy(tmp.begin(), tmp.end(), num_idxs<span style="color: #333333">-&gt;</span>begin() <span style="color: #333333">+</span> start);
    }
};
</pre></div>
